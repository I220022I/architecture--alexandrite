### **План внедрения мониторинга для компании «Александрит»**  

---

## **1. Мотивация: Зачем нужен мониторинг?**  
**Проблемы без мониторинга:**  
- Клиенты жалуются на «потерянные» заказы, но непонятно, где именно они застревают.  
- Операторы не могут быстро работать, потому что MES тормозит, но причину никто не видит.  
- После открытия API нагрузка выросла, но нет данных, где узкие места.  
- Бизнес теряет деньги из-за срывов сроков и ухода клиентов.  

**Что даст мониторинг:**  
✅ **Снижение количества жалоб** – можно заранее видеть проблемы и реагировать.  
✅ **Ускорение обработки заказов** – найдём узкие места (например, медленные расчёты в MES).  
✅ **Обоснование масштабирования** – данные покажут, куда инвестировать (сервера, оптимизацию кода).  
✅ **Прозрачность для бизнеса** – можно строить отчёты по SLA (например, «90% заказов должны рассчитываться за 5 минут»).  

**Бизнес-аргумент:**  
Сейчас компания теряет клиентов из-за непредсказуемых задержек. Мониторинг поможет:  
- Снизить процент отказов партнёров.  
- Увеличить скорость обработки заказов → больше выручки.  
- Избежать штрафов за срывы сроков.  

---

## **2. Выбор подхода к мониторингу**  
Разные части системы требуют разных метрик.  

| **Компонент**       | **Подход**               | **Почему?** |
|---------------------|--------------------------|-------------|
| **MES (расчёт стоимости, заказы)** | **Четыре золотых сигнала** (Latency, Traffic, Errors, Saturation) | Критично для бизнеса, нужно видеть задержки и ошибки. |
| **RabbitMQ (очереди)**           | **USE** (Utilization, Saturation, Errors) | Очереди — узкое место, важно следить за перегрузкой. |
| **API (B2B-партнёры)**          | **RED** (Rate, Errors, Duration) | Нужно контролировать нагрузку и SLA для партнёров. |
| **Frontend (онлайн-конструктор)** | **Custom (Web Vitals + бизнес-метрики)** | Важна скорость загрузки и конверсия в заказы. |

---

## **3. Метрики для мониторинга**  

### **A. MES (расчёт стоимости и обработка заказов)**  
| **Метрика**                     | **Зачем?** | **Ярлыки (labels)** |
|----------------------------------|------------|---------------------|
| Время расчёта стоимости (Latency) | Основная боль клиентов. | `model_complexity=high/low`, `source=api/web` |
| Количество заказов в статусах (Traffic) | Потерянные заказы часто зависают между статусами. | `status=SUBMITTED/PRICE_CALCULATED` |
| Ошибки расчёта (Errors)          | Клиенты получают некорректные цены. | `error_type=timeout/validation` |
| Загрузка CPU (Saturation)        | MES тормозит при высокой нагрузке. | `service=price_calculation` |

### **B. RabbitMQ (очереди)**  
| **Метрика**              | **Зачем?** | **Ярлыки** |
|--------------------------|------------|------------|
| Длина очереди (Saturation) | Если очередь растёт — заказы «зависают». | `queue_type=price_calculation` |
| Ошибки доставки (Errors)  | Сообщения теряются → заказы пропадают. | `error=reject/timeout` |

### **C. API для партнёров (B2B)**  
| **Метрика**          | **Зачем?** | **Ярлыки** |
|----------------------|------------|------------|
| Количество запросов (Rate) | Выявить злоупотребления или всплески. | `partner_id=123`, `endpoint=/calculate` |
| Время ответа (Duration) | SLA для партнёров. | `endpoint=/orders` |
| 5xx ошибки (Errors)   | Партнёры получают ошибки вместо заказов. | `status_code=500/503` |

### **D. Frontend (онлайн-конструктор)**  
| **Метрика**          | **Зачем?** | **Ярлыки** |
|----------------------|------------|------------|
| LCP (скорость загрузки) | Если тормозит — пользователи уходят. | `page=constructor` |
| Конверсия в заказ    | Сколько пользователей дошли до оплаты. | `source=upload/constructor` |

---

## **4. Инструменты и внедрение**  
**Стек:**  
- **Backend-метрики:** Prometheus + Grafana (уже используется в Yandex Cloud).  
- **Логи:** ELK (Elasticsearch + Kibana) для анализа ошибок.  
- **Frontend:** Sentry + Яндекс.Метрика (дополнительно к RED-метрикам).  

**План внедрения:**  
1. **Настроить сбор метрик MES и RabbitMQ** (первые 2 недели).  
2. **Добавить алерты** (например, если очередь RabbitMQ > 1000 сообщений).  
3. **Настроить дашборды для операторов** (статусы заказов + задержки).  
4. **Интегрировать мониторинг API** (SLA для партнёров).  

**Подробнее**

## **Этап 1: Инфраструктура мониторинга (2-3 недели)**  
**Цель:** Развернуть базовый сбор метрик и логов, чтобы начать анализ проблем.  

### **1.1. Развернуть хранилище метрик**  
- **Задача:** Создать Managed Prometheus (Yandex Managed Service for Prometheus) или развернуть свой кластер.  
- **Почему:** Prometheus — стандарт для мониторинга временных рядов, интегрируется с Grafana.  
- **Что проверить:**  
  - Достаточно ли памяти и CPU для хранения метрик (начнём с 30 дней хранения).  
  - Настроить retention policy (например, 30 дней для детальных данных, 90 дней — агрегированных).  

### **1.2. Настроить сбор метрик с MES и RabbitMQ**  
- **Задача:** Внедрить экспортеры метрик:  
  - Для **MES (C#)** → `prometheus-net` (библиотека для .NET).  
  - Для **RabbitMQ** → `rabbitmq-prometheus` (официальный плагин).  
  - Для **Java-сервисов (CRM, онлайн-магазин)** → `micrometer-registry-prometheus`.  
- **Почему:** Без экспортеров Prometheus не сможет собирать данные.  

### **1.3. Настроить Grafana для визуализации**  
- **Задача:** Развернуть Grafana (можно через Yandex Managed Grafana).  
- **Что сделать:**  
  - Подключить Prometheus как источник данных.  
  - Создать **первый дашборд для операторов MES** (статусы заказов, время расчёта стоимости).  

### **1.4. Настроить базовые алерты**  
- **Задача:** Добавить в Prometheus Alertmanager или Yandex Monitoring Alerts.  
- **Какие алерты:**  
  - Очередь RabbitMQ > 1000 сообщений.  
  - MES не отвечает > 1 минуты.  
  - 5xx ошибки в API > 5% запросов.  

---

## **Этап 2: Глубокая интеграция (3-4 недели)**  
**Цель:** Полноценный мониторинг всех ключевых компонентов.  

### **2.1. Добавить бизнес-метрики**  
- **Задача:** Настроить сбор:  
  - **Конверсия заказов** (сколько пользователей дошли до оплаты).  
  - **Среднее время расчёта стоимости** (разбивка по сложности моделей).  
- **Как:**  
  - Внедрить кастомные метрики в Prometheus (например, `orders_created_total`).  
  - Добавить ярлыки: `source=api/web`, `model_type=custom/premade`.  

### **2.2. Настроить логирование ошибок**  
- **Задача:** Развернуть ELK-стек (Elasticsearch + Logstash + Kibana) или использовать Managed Elastic.  
- **Что ловить:**  
  - Ошибки валидации 3D-моделей в MES.  
  - Сообщения об ошибках из RabbitMQ (dead-letter queue).  

### **2.3. Мониторинг API для партнёров**  
- **Задача:** Внедрить RED-метрики (Rate, Errors, Duration) для B2B-API.  
- **Как:**  
  - Использовать Prometheus + API Gateway (например, Yandex API Gateway).  
  - Добавить метрики:  
    - `http_requests_total` (с тегами `partner_id`, `endpoint`).  
    - `http_request_duration_seconds` (перцентили p95, p99).  

---

## **Этап 3: Оптимизация и масштабирование (2+ месяца)**  
**Цель:** Автоматизация и прогнозирование проблем.  

### **3.1. Настроить автоскейлинг на основе метрик**  
- **Задача:** Связать Prometheus с Kubernetes/Yandex Compute Cloud для автоматического масштабирования.  
- **Пример правила:**  
  - Если CPU MES > 80% более 5 минут → добавить 1 инстанс.  

### **3.2. Внедрить SLO/SLA-дашборды**  
- **Задача:** Определить Service Level Objectives (например, «95% заказов должны рассчитываться за 5 минут»).  
- **Как:**  
  - Использовать Grafana + Prometheus для отслеживания выполнения SLO.  
  - Настроить алерты при нарушении (например, SLO < 90%).  

### **3.3. Добавить синтетические тесты**  
- **Задача:** Настроить проверки доступности API (например, через Yandex Cloud Monitoring).  
- **Что тестировать:**  
  - Критические пути: расчёт стоимости, создание заказа.  

---

## **Итого: Что получит бизнес после внедрения?**  
- **Через 1 месяц:** Появится видимость узких мест (например, тормозящие очереди RabbitMQ).  
- **Через 3 месяца:** Снизятся жалобы на «потерянные» заказы (благодаря алертам).  
- **Через 6 месяцев:** Можно будет прогнозировать нагрузку и масштабировать систему заранее.  
