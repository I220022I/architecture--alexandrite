### **План внедрения кеширования в компании «Александрит»**  

---

## **1. Анализ проблемных мест**  

**Ключевые узкие места:**  
1. **MES API** – долгий расчёт стоимости (2-30 мин).  
2. **Дашборд оператора** – медленная загрузка списка заказов.  
3. **Частые запросы статусов заказов** – CRM и онлайн-магазин постоянно опрашивают MES.  

**Что стоит закешировать:**  
✅ **Результаты расчёта стоимости** (если модель не менялась).  
✅ **Списки заказов по статусам** (для дашборда оператора).  
✅ **Статусы заказов** (чтобы снизить нагрузку на MES DB).  

---

## **2. Мотивация**  

### **Почему нужно кеширование?**  
- **Ускорение MES**: Расчёт стоимости – самое узкое место. Кеш сократит время ответа с 30 мин до 1 сек.  
- **Улучшение UX операторов**: Дашборд будет грузиться мгновенно.  
- **Снижение нагрузки на БД**: 80% запросов к MES DB – это чтение статусов.  

### **Какие элементы кешируем:**  
| **Компонент**       | **Данные для кеширования** | **Ожидаемый эффект** |  
|---------------------|---------------------------|----------------------|  
| **MES API**         | Результаты расчёта стоимости (`price`, `model_hash`) | Сокращение времени ответа |  
| **MES DB**          | Списки заказов по статусам (`status=MANUFACTURING_STARTED`) | Ускорение дашборда |  
| **CRM/Shop API**    | Статусы заказов (`order_status`) | Меньше запросов к MES |  

---

## **3. Предлагаемое решение**  

### **Тип кеширования: Серверное**  
**Почему не клиентское:**  
- Данные должны быть актуальны для всех пользователей (операторы, менеджеры, клиенты).  
- Клиенты (браузеры/мобильные приложения) не могут гарантировать синхронизацию.  

### **Паттерн: Cache-Aside (Lazy Loading)**  
**Как работает:**  
1. При запросе данных сначала проверяем кеш.  
2. Если нет в кеше – грузим из БД и сохраняем в кеш.  

**Почему именно он:**  
- **Простота**: Не требует сложной синхронизации.  
- **Гибкость**: Можно кешировать только горячие данные.  
- **Надёжность**: При падении кеша система продолжает работать (с замедлением).  

**Почему не другие паттерны:**  
- **Write-Through**: Слишком нагружает кеш при частых записях (например, обновление статусов).  
- **Refresh-Ahead**: Неэффективно для редко запрашиваемых данных (например, архивные заказы).  

### **Технологии:**  
- **Redis** – для хранения кеша (высокая скорость, поддержка TTL).  
- **Spring Cache (Java)** + **IDistributedCache (.NET)** – для интеграции.  

---

## **4. Диаграмма последовательности**  

Диаграмма приложена в task5.  
**Пояснение:**  
1. **Чтение**: Сначала проверяем кеш, потом БД.  
2. **Запись**: Обновляем БД и инвалидируем кеш.  

---

## **5. Инвалидация кеша**  

### **Стратегия: Инвалидация по ключу + TTL**  
**Как работает:**  
- При изменении данных (например, статуса заказа) удаляем связанные ключи:  
  - `orders:IN_PROGRESS` – список заказов.  
  - `order:12345` – конкретный заказ.  
- **TTL (5 мин)** – страховка на случай пропуска инвалидации.  

**Почему эта стратегия:**  
- **Точность**: Гарантирует актуальность данных после изменений.  
- **Простота**: Не требует сложной логики (как Write-Behind).  

**Почему не другие:**  
- **Только TTL**: Риск показа устаревших данных.  
- **Полная инвалидация**: Слишком ресурсоёмко (кеш будет пустым).  

---

## **6. Сравнительный анализ**  

| **Критерий**       | **Cache-Aside**       | **Write-Through**     | **Refresh-Ahead**     |  
|--------------------|-----------------------|-----------------------|-----------------------|  
| **Скорость чтения**| (кеш + БД)     | (только кеш) | (предзагрузка) |  
| **Скорость записи**| (инвалидация)  | (запись в кеш + БД) | (асинхронная)   |  
| **Сложность**      | (простое)          | (синхронизация) | (фоновые задачи) |  
| **Актуальность данных** | (если инвалидация корректна) | (всегда актуально) | (риск устаревания) |  
| **Подходит для**   | Частые чтения, редкие записи | Высокие требования к актуальности | Прогнозируемые запросы |  

**Итоговый выбор:** Cache-Aside – оптимален для MES (баланс скорости и простоты).  

---

## **7. План внедрения**  
1. **Этап 1 (2 недели)**:  
   - Развернуть Redis в Yandex Cloud.  
   - Добавить кеширование расчёта стоимости в MES API.  
2. **Этап 2 (1 месяц)**:  
   - Внедрить кеширование дашборда оператора.  
   - Настроить инвалидацию при изменении статусов.  
3. **Этап 3 (2 месяца)**:  
   - Кеширование статусов для CRM/онлайн-магазина.  

**Ожидаемый результат:**  
- Время отклика MES сократится с 30 мин до 1 сек для расчётов.  
- Дашборд оператора будет грузиться за 0.5 сек вместо 10 сек.
