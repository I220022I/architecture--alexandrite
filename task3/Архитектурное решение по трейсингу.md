# **Архитектурное решение по трейсингу»**  

## **1. Потенциальные проблемы: Где теряются заказы?**  

### **Компоненты, где заказы могут «ломаться»:**  
1. **Онлайн-магазин**  
   - Зависание при загрузке 3D-модели.  
   - Ошибки при переходе из `INITIATED` → `FILE_UPLOADED`.  

2. **RabbitMQ (очереди между CRM и MES)**  
   - Потеря сообщений (например, из-за переполнения очереди).  
   - Задержки в доставке → заказ «висит» в статусе `SUBMITTED`.  

3. **MES (C#)**  
   - Долгий расчёт стоимости (30+ минут).  
   - Ошибки валидации 3D-моделей → заказ не переходит в `PRICE_CALCULATED`.  

4. **CRM**  
   - Задержки при подтверждении заказа (`MANUFACTURING_APPROVED`).  
   - Проблемы синхронизации статусов с MES.  

5. **B2B API**  
   - Таймауты при вызове `/calculate` → партнёры не получают ответ.  

### **Данные для трейсинга:**  
- **ID заказа** (корреляция между системами).  
- **Временные метки** (когда заказ попал в каждую систему).  
- **Статусы заказа** (переходы между этапами).  
- **Ошибки** (например, «невалидная 3D-модель»).  
- **Время выполнения операций** (например, расчёт стоимости).  

---  

## **2. Мотивация: Зачем нужен трейсинг?**  

### **Проблемы без трейсинга:**  
- Невозможно найти, где именно «завис» заказ.  
- Операторы и поддержка тратят часы на ручной поиск проблем.  
- Бизнес теряет клиентов из-за непредсказуемых задержек.  

### **Что даст трейсинг:**  
✅ **Скорость диагностики проблем** – можно сразу увидеть, в какой системе заказ «застрял».  
✅ **Снижение времени простоя** – быстрое исправление ошибок (например, перезапуск зависшего расчета).  
✅ **Улучшение SLA** – прозрачность для партнёров (например, «90% заказов обрабатываются за 24 часа»).  

### **Технические и бизнес-метрики, на которые повлияет трейсинг:**  
1. **Среднее время обработки заказа** (от `INITIATED` до `SHIPPED`).  
2. **Процент «зависших» заказов** (например, >24 часов в статусе `SUBMITTED`).  
3. **Количество ошибок на этапе расчёта стоимости** (MES).  
4. **Конверсия в оформление заказа** (сколько пользователей дошли до `SUBMITTED`).  
5. **SLA для B2B-партнёров** (например, «расчёт стоимости за 5 минут»).  

---  

## **3. Предлагаемое решение**  

### **Технологии:**  
- **OpenTelemetry** (стандарт для трейсинга, поддерживает C#, RabbitMQ).  
- **Jaeger** (для визуализации трейсов).  

### **Что нужно сделать:**  
1. **Инструментировать сервисы:**  
   - Добавить OpenTelemetry SDK в:  
     - Онлайн-магазин.  
     - CRM.  
     - MES (C# через OpenTelemetry .NET).  
   - Настроить трейсинг для RabbitMQ.  

2. **Развернуть Jaeger:**  
   - Использовать Managed Jaeger (например, Yandex Managed Service for Jaeger).  
   - Настроить sampling (например, 100% трейсов для ошибок, 10% – для успешных запросов).  

3. **Интеграция с мониторингом:**  (дополнительно)
   - Связать Jaeger с Grafana (через плагин).  
   - Настроить алерты на «долгие трейсы» (например, расчёт стоимости >10 минут).  

---  

## **4. Компромиссы**  

### **Когда трейсинг не поможет или слишком дорог:**  
1. **Проприетарные системы без поддержки OpenTelemetry**  
   - Например, если MES использует закрытый формат логов, потребуется доработка.  
   - *Альтернатива:* Логировать ключевые события в БД и анализировать их отдельно.  

2. **Высоконагруженные очереди (RabbitMQ)**  
   - Трейсинг каждого сообщения может создать нагрузку.  
   - *Решение:* Выборочный sampling (только для проблемных заказов).  

3. **Фронтенд (Vue/React)**  
   - Трейсинг на клиенте сложен и требует много ресурсов.  
   - *Альтернатива:* Использовать User Session Tracking (например, через Яндекс.Метрику).  

---  

## **5. Безопасность**  

### **Меры защиты трейсинга:**  
1. **Аутентификация и авторизация:**  
   - Jaeger доступен только через VPN или корпоративную сеть.  
   - Ролевая модель:  
     - **Разработчики** – доступ к трейсам своих сервисов.  
     - **Поддержка** – только просмотр (без удаления данных).  

2. **Маскирование данных:**  
   - Не логировать персональные данные (например, email клиента).  
   - Шифровать ID заказов в трейсах (если передаются через публичные API).  

3. **Ограничение хранения:**  
   - Трейсы хранятся 7 дней (для баланса между анализом и стоимостью).  
   - Критические ошибки сохраняются в Elasticsearch на 30 дней.  

---  

## **Итого:**  
Трейсинг позволит:  
- Находить «потерянные» заказы за минуты вместо часов.  
- Улучшить SLA для клиентов и партнёров.  
- Снизить нагрузку на поддержку.  
