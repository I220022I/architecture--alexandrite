### **План внедрения логирования в компании «Александрит»**  

---

## **1. Список логов**  

### **Основные логи (INFO)**
| **Система**       | **Событие**                          | **Данные для логирования** |
|-------------------|--------------------------------------|---------------------------|
| **Internet Shop** | Создание заказа (`INITIATED`)        | `user_id`, `order_id`, `timestamp` |
| **Internet Shop** | Загрузка 3D-модели (`FILE_UPLOADED`) | `order_id`, `file_size`, `validation_status` |
| **Shop API**      | Отправка заказа в очередь (`SUBMITTED`) | `order_id`, `queue_status`, `timestamp` |
| **MES API**      | Начало расчета стоимости (`PRICE_CALCULATED`) | `order_id`, `calculation_time`, `model_complexity` |
| **CRM API**      | Подтверждение заказа (`MANUFACTURING_APPROVED`) | `order_id`, `manager_id`, `timestamp` |
| **RabbitMQ**     | Сообщение доставлено в MES          | `message_id`, `order_id`, `processing_time` |
| **MES**          | Изменение статуса заказа (например, `MANUFACTURING_STARTED`) | `order_id`, `operator_id`, `new_status` |

### **Другие уровни логирования**
| **Уровень** | **Когда использовать** | **Пример** |
|-------------|------------------------|------------|
| **DEBUG**   | Разработка и тестирование | Логирование промежуточных шагов расчета стоимости в MES |
| **WARN**    | Нестандартные ситуации, но не ошибки | Повторная отправка сообщения в RabbitMQ |
| **ERROR**   | Критические сбои       | Ошибка валидации 3D-модели (`invalid_format`) |
| **FATAL**   | Система не может работать | Отказ подключения к БД |

---

## **2. Мотивация**  

### **Почему нужно логирование?**  
- **Отслеживание проблем**: Позволяет быстро находить, где «завис» заказ.  
- **Анализ инцидентов**: Понять причину сбоев (например, почему RabbitMQ теряет сообщения).  
- **Поддержка SLA**: Доказательство выполнения/нарушения условий для партнёров.  
- **Безопасность**: Выявление подозрительной активности (например, DDoS).  

### **Приоритеты внедрения**  
1. **MES API + RabbitMQ** – самые критические узлы, где теряются заказы.  
2. **Shop API** – проблемы с созданием заказов влияют на конверсию.  
3. **CRM API** – важен для отслеживания подтвержденных заказов.  

**Трейсинг vs. Логирование**:  
- Сначала **логирование** (проще внедрить, сразу даёт данные для анализа).  
- Потом **трейсинг** (требует больше ресурсов, но даёт полную картину).  

---

## **3. Предлагаемое решение**  

### **Технологии**  
- **ELK-стек** (Elasticsearch + Logstash + Kibana) – для хранения и анализа логов.  
- **Fluentd/Fluent Bit** – для сбора и передачи логов.  
- **Kafka** (опционально) – буферизация логов при высокой нагрузке.  

### **Что доработать**  
1. **Настроить сбор логов** во всех API (Spring Boot, C#) через:  
   - `Logback` (Java) → отправка в Fluentd.  
   - `Serilog` (C#) → отправка в Fluentd.  
2. **Добавить контекст** (например, `order_id` во всех связанных логах).  
3. **Интегрировать с мониторингом**: Связь логов ошибок с алертами в Prometheus.  

---

## **4. Безопасность**  

### **Меры защиты**  
- **Маскирование данных**:  
  - Не логировать `payment_data`, `email`, `phone`.  
  - Заменять на `***` в Fluentd/Logstash.  
- **Доступ**:  
  - **Kibana**: Только для DevOps и поддержки (роли: `read_only`, `admin`).  
  - **Elasticsearch**: Доступ через VPN.  
- **Аудит**: Логирование всех запросов к Kibana.  

---

## **5. Хранение логов**  

| **Тип логов**   | **Срок хранения** | **Индекс в Elasticsearch** |  
|----------------|-------------------|---------------------------|  
| **INFO/DEBUG** | 7 дней            | `logs-{system}-%{+YYYY.MM.dd}` |  
| **ERROR**      | 30 дней           | `error-logs-{system}-%{+YYYY.MM}` |  
| **FATAL**      | 1 год             | Отдельный индекс с бэкапами в S3 |  

**Ограничения**:  
- 50 ГБ на сервис в день (можно сжимать в Logstash).  
- Автоматическое удаление старых индексов.  

---

## **6. Анализ логов**  

### **Решения для анализа**  
1. **Kibana Dashboards**:  
   - Отслеживание ошибок по API.  
   - Графики нагрузки (например, RPS для Shop API).  
2. **Алертинг**:  
   - **ElastAlert**: Уведомления в Slack/Mattermost при:  
     - Резком росте ERROR (возможный сбой).  
     - Аномальном числе заказов (DDoS).  
3. **Поиск аномалий**:  
   - Machine Learning (в Kibana) для обнаружения неочевидных паттернов.  

---

## **7. Технология: Критерии выбора**  

| **Критерий**          | **Варианты**               | **Выбор**     |  
|-----------------------|---------------------------|--------------|  
| **Масштабируемость**  | ELK, Loki, Graylog         | ELK          |  
| **Поддержка форматов**| JSON, Syslog, Plain Text   | ELK          |  
| **Интеграция с C#/Java** | Serilog, Logback       | ELK + Fluentd|  
| **Стоимость**         | Self-hosted vs. Managed    | Yandex Managed Elastic |  
| **Скорость поиска**   | Elasticsearch vs. ClickHouse| Elasticsearch|  

**Итоговый стек**:  
- **Сбор**: Fluentd (легковесный агент).  
- **Хранение**: Elasticsearch (быстрый поиск).  
- **Визуализация**: Kibana (готовые дашборды).  

---

## **Итого:**  
1. **Сначала** внедряем логирование для MES API и RabbitMQ – это решит 80% проблем с «потерянными» заказами.  
2. **Параллельно** настраиваем алерты на ошибки.  
3. **Позже** добавляем трейсинг для полной картины.  
